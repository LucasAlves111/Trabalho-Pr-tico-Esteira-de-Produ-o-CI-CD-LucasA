name: CI - ValidaÃ§Ã£o de CÃ³digo

on:
  pull_request:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Verificar existÃªncia do index.html
        run: |
          echo "ğŸ” Verificando se index.html existe na raiz..."
          if [ ! -f "index.html" ]; then
            echo "âŒ ERRO: Arquivo index.html nÃ£o encontrado na raiz do projeto!"
            echo "O GitHub Pages requer um arquivo index.html na raiz."
            exit 1
          fi
          echo "âœ… Arquivo index.html encontrado!"
      
      - name: Instalar dependÃªncias para validaÃ§Ã£o
        run: |
          npm install -g htmlhint
          echo "âœ… HTMLHint instalado com sucesso"
      
      - name: Executar Linter HTML
        run: |
          echo "ğŸ” Executando validaÃ§Ã£o de HTML..."
          htmlhint "**/*.html" || exit 1
          echo "âœ… HTML validado com sucesso!"
      
      - name: Verificar tamanho dos arquivos
        run: |
          echo "ğŸ” Verificando arquivos maiores que 500KB..."
          large_files=$(find . -type f -size +500k -not -path "./.git/*" -not -path "./node_modules/*")
          
          if [ -n "$large_files" ]; then
            echo "âŒ ERRO: Os seguintes arquivos excedem 500KB:"
            echo "$large_files"
            exit 1
          fi
          echo "âœ… Todos os arquivos estÃ£o dentro do limite de 500KB"
      
      - name: Varredura de comentÃ¡rios proibidos
        run: |
          echo "ğŸ” Verificando comentÃ¡rios e termos sensÃ­veis..."
          
          # Buscar por TODO, FIXME
          if grep -r -i -E "(TODO|FIXME)" --include="*.html" --include="*.css" --include="*.js" .; then
            echo "âŒ ERRO: ComentÃ¡rios TODO ou FIXME encontrados no cÃ³digo!"
            echo "Remova todos os comentÃ¡rios de desenvolvimento antes de fazer o merge."
            exit 1
          fi
          
          # Buscar por termos sensÃ­veis
          if grep -r -i -E "(senha|password)" --include="*.html" --include="*.css" --include="*.js" .; then
            echo "âŒ ERRO: Termos sensÃ­veis (senha/password) encontrados no cÃ³digo!"
            exit 1
          fi
          
          echo "âœ… Nenhum comentÃ¡rio proibido ou termo sensÃ­vel encontrado"
      
      - name: Validar links e caminhos de imagens
        run: |
          echo "ğŸ” Validando links e caminhos de imagens..."
          
          # Instalar ferramenta para validaÃ§Ã£o
          npm install -g link-check || true
          
          # Script Python para validar links locais e imagens
          cat > validate_links.py << 'EOF'
          import re
          import os
          import sys
          from pathlib import Path
          
          errors = []
          
          # Encontrar todos os arquivos HTML
          html_files = list(Path('.').rglob('*.html'))
          
          for html_file in html_files:
              if '.git' in str(html_file) or 'node_modules' in str(html_file):
                  continue
                  
              with open(html_file, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # Verificar imagens locais
              img_pattern = r'<img[^>]+src=["\']((?!http)[^"\']+)["\']'
              images = re.findall(img_pattern, content)
              
              for img_path in images:
                  # Limpar o caminho
                  img_path = img_path.split('?')[0].split('#')[0]
                  full_path = os.path.join(os.path.dirname(html_file), img_path)
                  
                  if not os.path.exists(full_path) and not os.path.exists(img_path):
                      errors.append(f"âŒ Imagem nÃ£o encontrada: {img_path} em {html_file}")
              
              # Verificar links locais (href)
              link_pattern = r'href=["\']((?!http|#|mailto:)[^"\']+)["\']'
              links = re.findall(link_pattern, content)
              
              for link_path in links:
                  link_path = link_path.split('?')[0].split('#')[0]
                  if link_path and not link_path.startswith('#'):
                      full_path = os.path.join(os.path.dirname(html_file), link_path)
                      
                      if not os.path.exists(full_path) and not os.path.exists(link_path):
                          errors.append(f"âŒ Link local nÃ£o encontrado: {link_path} em {html_file}")
          
          if errors:
              print("\n".join(errors))
              sys.exit(1)
          else:
              print("âœ… Todos os links e imagens locais sÃ£o vÃ¡lidos!")
          EOF
          
          python3 validate_links.py || exit 1
      
      - name: Resumo da ValidaÃ§Ã£o
        if: success()
        run: |
          echo "ğŸ‰ =================================="
          echo "ğŸ‰ VALIDAÃ‡ÃƒO CONCLUÃDA COM SUCESSO!"
          echo "ğŸ‰ =================================="
          echo ""
          echo "âœ… index.html existe na raiz"
          echo "âœ… HTML validado pelo Linter"
          echo "âœ… Nenhum arquivo excede 500KB"
          echo "âœ… Sem comentÃ¡rios TODO/FIXME"
          echo "âœ… Sem termos sensÃ­veis no cÃ³digo"
          echo "âœ… Links e imagens validados"
          echo ""
          echo "O cÃ³digo estÃ¡ pronto para produÃ§Ã£o! ğŸš€"